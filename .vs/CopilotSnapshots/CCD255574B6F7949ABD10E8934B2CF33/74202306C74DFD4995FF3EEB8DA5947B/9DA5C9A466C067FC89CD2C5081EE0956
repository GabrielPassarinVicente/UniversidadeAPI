-- ============================================
-- SCRIPT COMPLETO: Criar Banco de Dados UniversidadeAPI
-- Versão: 1.0
-- Data: 2024
-- Descrição: Cria todas as tabelas com relacionamentos many-to-many
-- ============================================

-- PASSO 1: Remover banco existente e criar novo
DROP DATABASE IF EXISTS mydb;
CREATE DATABASE mydb CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE mydb;

-- ============================================
-- PASSO 2: Criar tabelas independentes (sem FK)
-- ============================================

-- Tabela: Usuario (para autenticação)
CREATE TABLE Usuario (
    Id INT AUTO_INCREMENT PRIMARY KEY,
    Username VARCHAR(50) NOT NULL UNIQUE,
    PasswordHash VARCHAR(255) NOT NULL,
    Email VARCHAR(100) NOT NULL UNIQUE,
    DataCriacao DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_username (Username),
    INDEX idx_email (Email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela: Departamentos
CREATE TABLE Departamentos (
    IdDepartamentos INT AUTO_INCREMENT PRIMARY KEY,
    Nome VARCHAR(100) NOT NULL,
    Codigo VARCHAR(20) UNIQUE,
    Descricao TEXT,
    DataCriacao DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_nome (Nome),
    INDEX idx_codigo (Codigo)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela: Professores
CREATE TABLE Professores (
    IdProfessores INT AUTO_INCREMENT PRIMARY KEY,
    Nome VARCHAR(100) NOT NULL,
    INDEX idx_nome (Nome)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela: Aluno
CREATE TABLE Aluno (
    Id INT AUTO_INCREMENT PRIMARY KEY,
    NomeCompleto VARCHAR(150) NOT NULL,
    DataNascimento DATE NOT NULL,
    Cpf VARCHAR(14) NOT NULL UNIQUE,
    Endereco VARCHAR(255),
    Telefone VARCHAR(20),
    Email VARCHAR(100) UNIQUE,
    DataMatricula DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_nome (NomeCompleto),
    INDEX idx_cpf (Cpf),
    INDEX idx_email (Email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- PASSO 3: Criar tabelas com FK simples
-- ============================================

-- Tabela: Cursos (depende de Departamentos)
CREATE TABLE Cursos (
    IdCursos INT AUTO_INCREMENT PRIMARY KEY,
    Nome VARCHAR(100) NOT NULL,
    CargaHoraria VARCHAR(20),
    Departamentos_idDepartamentos INT NOT NULL,
    INDEX idx_nome (Nome),
    INDEX idx_departamento (Departamentos_idDepartamentos),
    CONSTRAINT fk_cursos_departamentos 
        FOREIGN KEY (Departamentos_idDepartamentos) 
        REFERENCES Departamentos(IdDepartamentos)
        ON DELETE RESTRICT
        ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela: Disciplina (depende de Cursos e Professores)
CREATE TABLE Disciplina (
    IdDisciplina INT AUTO_INCREMENT PRIMARY KEY,
    Nome VARCHAR(100) NOT NULL,
    Codigo VARCHAR(20) UNIQUE,
    CargaHoraria INT NOT NULL,
    Creditos INT,
    Ementa TEXT,
    Curso_IdCursos INT NOT NULL,
    Professor_IdProfessores INT,
    DataCriacao DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_nome (Nome),
    INDEX idx_codigo (Codigo),
    INDEX idx_curso (Curso_IdCursos),
    INDEX idx_professor (Professor_IdProfessores),
    CONSTRAINT fk_disciplina_curso 
        FOREIGN KEY (Curso_IdCursos) 
        REFERENCES Cursos(IdCursos)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    CONSTRAINT fk_disciplina_professor 
        FOREIGN KEY (Professor_IdProfessores) 
        REFERENCES Professores(IdProfessores)
        ON DELETE SET NULL
        ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- PASSO 4: Criar tabela de relacionamento many-to-many
-- ============================================

-- Tabela: CursoProfessor (relacionamento many-to-many entre Cursos e Professores)
CREATE TABLE CursoProfessor (
    IdCursoProfessor INT AUTO_INCREMENT PRIMARY KEY,
    Cursos_IdCursos INT NOT NULL,
    Professores_IdProfessores INT NOT NULL,
    DataVinculacao DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_curso (Cursos_IdCursos),
    INDEX idx_professor (Professores_IdProfessores),
    UNIQUE KEY uk_curso_professor (Cursos_IdCursos, Professores_IdProfessores),
    CONSTRAINT fk_cursoprof_curso 
        FOREIGN KEY (Cursos_IdCursos) 
        REFERENCES Cursos(IdCursos)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    CONSTRAINT fk_cursoprof_professor 
        FOREIGN KEY (Professores_IdProfessores) 
        REFERENCES Professores(IdProfessores)
        ON DELETE CASCADE
        ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- PASSO 5: Inserir dados de exemplo
-- ============================================

-- Inserir Usuários de teste
INSERT INTO Usuario (Username, PasswordHash, Email, DataCriacao) VALUES
('admin', '$2a$11$K5X/WqP7p0Z4rG3R.zj0NeZq4xYQYH3L3f.3h3Z3h3Z3h3Z3h3Z3h3', 'admin@universidade.com', NOW()),
('aluno1', '$2a$11$K5X/WqP7p0Z4rG3R.zj0NeZq4xYQYH3L3f.3h3Z3h3Z3h3Z3h3Z3h3', 'aluno1@universidade.com', NOW()),
('professor1', '$2a$11$K5X/WqP7p0Z4rG3R.zj0NeZq4xYQYH3L3f.3h3Z3h3Z3h3Z3h3Z3h3', 'professor1@universidade.com', NOW());

-- Inserir Departamentos
INSERT INTO Departamentos (Nome, Codigo, Descricao, DataCriacao) VALUES
('Ciências Exatas', 'DEXT', 'Departamento de Ciências Exatas e Tecnologia', NOW()),
('Ciências Humanas', 'DHUM', 'Departamento de Ciências Humanas', NOW()),
('Ciências da Saúde', 'DSAU', 'Departamento de Ciências da Saúde', NOW()),
('Engenharias', 'DENG', 'Departamento de Engenharias', NOW()),
('Administração', 'DADM', 'Departamento de Administração e Negócios', NOW());

-- Inserir Professores
INSERT INTO Professores (Nome) VALUES
('Prof. Dr. João Silva'),
('Prof. Dra. Maria Santos'),
('Prof. Dr. Pedro Costa'),
('Prof. Dra. Ana Oliveira'),
('Prof. Dr. Carlos Ferreira'),
('Prof. Dra. Juliana Lima'),
('Prof. Dr. Roberto Alves'),
('Prof. Dra. Fernanda Rocha'),
('Prof. Dr. Lucas Martins'),
('Prof. Dra. Patricia Souza');

-- Inserir Alunos
INSERT INTO Aluno (NomeCompleto, DataNascimento, Cpf, Endereco, Telefone, Email, DataMatricula) VALUES
('Gabriel Passarin Vicente', '2000-05-15', '123.456.789-01', 'Rua das Flores, 123', '(11) 98765-4321', 'gabriel@email.com', NOW()),
('Mariana Silva Costa', '1999-08-20', '234.567.890-12', 'Av. Principal, 456', '(11) 98765-4322', 'mariana@email.com', NOW()),
('Carlos Eduardo Santos', '2001-03-10', '345.678.901-23', 'Rua do Comércio, 789', '(11) 98765-4323', 'carlos@email.com', NOW()),
('Juliana Ferreira Lima', '2000-11-25', '456.789.012-34', 'Av. das Nações, 321', '(11) 98765-4324', 'juliana@email.com', NOW()),
('Fernando Oliveira Rocha', '1998-07-30', '567.890.123-45', 'Rua dos Pinheiros, 654', '(11) 98765-4325', 'fernando@email.com', NOW());

-- Inserir Cursos
INSERT INTO Cursos (Nome, CargaHoraria, Departamentos_idDepartamentos) VALUES
('Ciência da Computação', '3600h', 1),
('Engenharia de Software', '4000h', 1),
('Sistemas de Informação', '3200h', 1),
('Administração', '3000h', 5),
('Medicina', '7200h', 3),
('Psicologia', '4000h', 2),
('Engenharia Civil', '5000h', 4),
('Direito', '4000h', 2),
('Enfermagem', '4000h', 3),
('Arquitetura', '5000h', 4);

-- Inserir Disciplinas
INSERT INTO Disciplina (Nome, Codigo, CargaHoraria, Creditos, Ementa, Curso_IdCursos, Professor_IdProfessores, DataCriacao) VALUES
('Algoritmos e Estruturas de Dados', 'AED001', 80, 4, 'Estudo de algoritmos e estruturas de dados fundamentais', 1, 1, NOW()),
('Banco de Dados', 'BD001', 80, 4, 'Modelagem e implementação de bancos de dados relacionais', 1, 2, NOW()),
('Programação Orientada a Objetos', 'POO001', 80, 4, 'Conceitos e práticas de programação orientada a objetos', 1, 1, NOW()),
('Engenharia de Requisitos', 'ER001', 60, 3, 'Técnicas de levantamento e análise de requisitos', 2, 3, NOW()),
('Arquitetura de Software', 'AS001', 80, 4, 'Padrões e práticas de arquitetura de software', 2, 3, NOW()),
('Gestão de Projetos', 'GP001', 60, 3, 'Fundamentos de gestão de projetos de software', 2, 4, NOW()),
('Redes de Computadores', 'RC001', 80, 4, 'Fundamentos de redes e protocolos de comunicação', 3, 5, NOW()),
('Segurança da Informação', 'SI001', 60, 3, 'Conceitos e práticas de segurança da informação', 3, 5, NOW()),
('Teoria Geral da Administração', 'TGA001', 80, 4, 'Fundamentos da administração e gestão empresarial', 4, 6, NOW()),
('Marketing', 'MKT001', 60, 3, 'Princípios e estratégias de marketing', 4, 6, NOW());

-- Inserir relacionamentos Curso-Professor (many-to-many)
INSERT INTO CursoProfessor (Cursos_IdCursos, Professores_IdProfessores, DataVinculacao) VALUES
-- Ciência da Computação (Curso 1)
(1, 1, NOW()),
(1, 2, NOW()),
(1, 5, NOW()),
-- Engenharia de Software (Curso 2)
(2, 1, NOW()),
(2, 3, NOW()),
(2, 4, NOW()),
-- Sistemas de Informação (Curso 3)
(3, 2, NOW()),
(3, 5, NOW()),
-- Administração (Curso 4)
(4, 6, NOW()),
(4, 7, NOW()),
-- Medicina (Curso 5)
(5, 8, NOW()),
(5, 9, NOW()),
-- Psicologia (Curso 6)
(6, 9, NOW()),
(6, 10, NOW()),
-- Engenharia Civil (Curso 7)
(7, 4, NOW()),
(7, 7, NOW()),
-- Direito (Curso 8)
(8, 10, NOW()),
-- Enfermagem (Curso 9)
(9, 8, NOW()),
-- Arquitetura (Curso 10)
(10, 4, NOW()),
(10, 7, NOW());

-- ============================================
-- PASSO 6: Verificações finais
-- ============================================

-- Mostrar estrutura das tabelas criadas
SHOW TABLES;

-- Contar registros em cada tabela
SELECT 'Usuario' AS Tabela, COUNT(*) AS Total FROM Usuario
UNION ALL
SELECT 'Departamentos', COUNT(*) FROM Departamentos
UNION ALL
SELECT 'Professores', COUNT(*) FROM Professores
UNION ALL
SELECT 'Aluno', COUNT(*) FROM Aluno
UNION ALL
SELECT 'Cursos', COUNT(*) FROM Cursos
UNION ALL
SELECT 'Disciplina', COUNT(*) FROM Disciplina
UNION ALL
SELECT 'CursoProfessor', COUNT(*) FROM CursoProfessor;

-- Verificar relacionamentos Curso-Professor
SELECT 
    c.IdCursos,
    c.Nome AS CursoNome,
    p.IdProfessores,
    p.Nome AS ProfessorNome,
    cp.DataVinculacao
FROM Cursos c
INNER JOIN CursoProfessor cp ON c.IdCursos = cp.Cursos_IdCursos
INNER JOIN Professores p ON p.IdProfessores = cp.Professores_IdProfessores
ORDER BY c.IdCursos, p.Nome;

-- Mostrar cursos com quantidade de professores
SELECT 
    c.IdCursos,
    c.Nome AS Curso,
    d.Nome AS Departamento,
    COUNT(cp.Professores_IdProfessores) AS TotalProfessores
FROM Cursos c
LEFT JOIN Departamentos d ON c.Departamentos_idDepartamentos = d.IdDepartamentos
LEFT JOIN CursoProfessor cp ON c.IdCursos = cp.Cursos_IdCursos
GROUP BY c.IdCursos, c.Nome, d.Nome
ORDER BY c.Nome;

-- ============================================
-- PASSO 7: Criar views úteis (opcional)
-- ============================================

-- View: Cursos com seus departamentos e professores
CREATE OR REPLACE VIEW vw_CursosCompletos AS
SELECT 
    c.IdCursos,
    c.Nome AS CursoNome,
    c.CargaHoraria,
    d.Nome AS DepartamentoNome,
    d.Codigo AS DepartamentoCodigo,
    GROUP_CONCAT(p.Nome ORDER BY p.Nome SEPARATOR ', ') AS Professores,
    COUNT(DISTINCT cp.Professores_IdProfessores) AS TotalProfessores
FROM Cursos c
LEFT JOIN Departamentos d ON c.Departamentos_idDepartamentos = d.IdDepartamentos
LEFT JOIN CursoProfessor cp ON c.IdCursos = cp.Cursos_IdCursos
LEFT JOIN Professores p ON cp.Professores_IdProfessores = p.IdProfessores
GROUP BY c.IdCursos, c.Nome, c.CargaHoraria, d.Nome, d.Codigo;

-- View: Disciplinas completas
CREATE OR REPLACE VIEW vw_DisciplinasCompletas AS
SELECT 
    d.IdDisciplina,
    d.Nome AS DisciplinaNome,
    d.Codigo,
    d.CargaHoraria,
    d.Creditos,
    c.Nome AS CursoNome,
    p.Nome AS ProfessorNome
FROM Disciplina d
LEFT JOIN Cursos c ON d.Curso_IdCursos = c.IdCursos
LEFT JOIN Professores p ON d.Professor_IdProfessores = p.IdProfessores;

-- ============================================
-- FINALIZAÇÃO
-- ============================================

SELECT '========================================' AS '';
SELECT 'BANCO DE DADOS CRIADO COM SUCESSO!' AS '';
SELECT '========================================' AS '';
SELECT '' AS '';
SELECT 'Tabelas criadas:' AS '';
SELECT '- Usuario (autenticação)' AS '';
SELECT '- Departamentos' AS '';
SELECT '- Professores' AS '';
SELECT '- Aluno' AS '';
SELECT '- Cursos' AS '';
SELECT '- Disciplina' AS '';
SELECT '- CursoProfessor (many-to-many)' AS '';
SELECT '' AS '';
SELECT 'Views criadas:' AS '';
SELECT '- vw_CursosCompletos' AS '';
SELECT '- vw_DisciplinasCompletas' AS '';
SELECT '' AS '';
SELECT 'Dados de exemplo inseridos:' AS '';
SELECT '- 3 usuários' AS '';
SELECT '- 5 departamentos' AS '';
SELECT '- 10 professores' AS '';
SELECT '- 5 alunos' AS '';
SELECT '- 10 cursos' AS '';
SELECT '- 10 disciplinas' AS '';
SELECT '- 18 vínculos curso-professor' AS '';
SELECT '' AS '';
SELECT 'Próximos passos:' AS '';
SELECT '1. Reiniciar a API (Shift+F5, depois F5)' AS '';
SELECT '2. Testar endpoints de Cursos com Professores' AS '';
SELECT '3. Verificar logs para confirmar sucesso' AS '';
SELECT '' AS '';
SELECT '========================================' AS '';
