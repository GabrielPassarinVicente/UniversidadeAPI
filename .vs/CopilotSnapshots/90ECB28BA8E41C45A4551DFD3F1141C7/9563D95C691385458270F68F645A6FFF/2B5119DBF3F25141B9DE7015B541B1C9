-- =====================================================
-- SCRIPT COMPLETO: CRIAR BANCO DE DADOS COM CASCADE DELETE
-- Database: mydb
-- Exclusão em cascata configurada em TODOS os relacionamentos
-- =====================================================

-- =====================================================
-- 1. RECRIAR BANCO DE DADOS
-- =====================================================

DROP DATABASE IF EXISTS mydb;

CREATE DATABASE mydb 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

USE mydb;

-- =====================================================
-- 2. CRIAR TABELAS (SEM FOREIGN KEYS PRIMEIRO)
-- =====================================================

-- Tabela de Departamentos
CREATE TABLE Departamentos (
    idDepartamentos INT AUTO_INCREMENT PRIMARY KEY,
    Nome VARCHAR(100) NOT NULL,
    Codigo VARCHAR(20) UNIQUE,
    Descricao TEXT,
    DataCriacao DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_codigo (Codigo),
    INDEX idx_nome (Nome)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela de Usuários (Autenticação)
CREATE TABLE Usuario (
    Id INT AUTO_INCREMENT PRIMARY KEY,
    Username VARCHAR(50) NOT NULL UNIQUE,
    PasswordHash VARCHAR(255) NOT NULL,
    Email VARCHAR(100) NOT NULL UNIQUE,
    DataCriacao DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UltimoAcesso DATETIME NULL,
    Ativo BOOLEAN DEFAULT TRUE,
    INDEX idx_username (Username),
    INDEX idx_email (Email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela de Professores
CREATE TABLE Professores (
    IdProfessores INT AUTO_INCREMENT PRIMARY KEY,
    Nome VARCHAR(150) NOT NULL,
    Cpf VARCHAR(11) UNIQUE,
    Email VARCHAR(100),
    Telefone VARCHAR(20),
    Especializacao VARCHAR(100),
    DataContratacao DATE,
    Salario DECIMAL(10, 2),
    DataCriacao DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_nome (Nome),
    INDEX idx_cpf (Cpf),
    INDEX idx_email (Email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela de Cursos
CREATE TABLE Cursos (
    IdCursos INT AUTO_INCREMENT PRIMARY KEY,
    Nome VARCHAR(100) NOT NULL,
    CargaHoraria VARCHAR(20),
    Descricao TEXT,
    Nivel ENUM('Graduação', 'Pós-Graduação', 'Técnico', 'Mestrado', 'Doutorado') DEFAULT 'Graduação',
    Departamentos_idDepartamentos INT NOT NULL,
    DataCriacao DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_nome (Nome),
    INDEX idx_departamento (Departamentos_idDepartamentos)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela de Alunos
CREATE TABLE Aluno (
    Id INT AUTO_INCREMENT PRIMARY KEY,
    NomeCompleto VARCHAR(150) NOT NULL,
    DataNascimento DATE NOT NULL,
    Cpf VARCHAR(11) UNIQUE NOT NULL,
    Endereco VARCHAR(255),
    Telefone VARCHAR(20),
    Email VARCHAR(100) UNIQUE NOT NULL,
    DataMatricula DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    Status ENUM('Ativo', 'Inativo', 'Trancado', 'Formado') DEFAULT 'Ativo',
    DataCriacao DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_nome (NomeCompleto),
    INDEX idx_cpf (Cpf),
    INDEX idx_email (Email),
    INDEX idx_status (Status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela de Disciplinas
CREATE TABLE Disciplinas (
    IdDisciplina INT AUTO_INCREMENT PRIMARY KEY,
    Nome VARCHAR(100) NOT NULL,
    Codigo VARCHAR(20) UNIQUE,
    CargaHoraria INT NOT NULL,
    Creditos INT,
    Ementa TEXT,
    Curso_IdCursos INT NOT NULL,
    Professor_IdProfessores INT,
    DataCriacao DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_nome (Nome),
    INDEX idx_codigo (Codigo),
    INDEX idx_curso (Curso_IdCursos),
    INDEX idx_professor (Professor_IdProfessores)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela de Matrícula (Aluno x Curso)
CREATE TABLE Matricula (
    IdMatricula INT AUTO_INCREMENT PRIMARY KEY,
    Aluno_Id INT NOT NULL,
    Curso_IdCursos INT NOT NULL,
    DataMatricula DATETIME DEFAULT CURRENT_TIMESTAMP,
    Semestre VARCHAR(10),
    Ano INT,
    Status ENUM('Cursando', 'Concluído', 'Trancado', 'Cancelado') DEFAULT 'Cursando',
    UNIQUE KEY unique_aluno_curso (Aluno_Id, Curso_IdCursos),
    INDEX idx_aluno (Aluno_Id),
    INDEX idx_curso (Curso_IdCursos),
    INDEX idx_status (Status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela de Notas
CREATE TABLE Notas (
    IdNota INT AUTO_INCREMENT PRIMARY KEY,
    Aluno_Id INT NOT NULL,
    Disciplina_IdDisciplina INT NOT NULL,
    Nota1 DECIMAL(5, 2),
    Nota2 DECIMAL(5, 2),
    NotaFinal DECIMAL(5, 2),
    Frequencia DECIMAL(5, 2),
    Status ENUM('Aprovado', 'Reprovado', 'Cursando') DEFAULT 'Cursando',
    Semestre VARCHAR(10),
    Ano INT,
    DataLancamento DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_aluno (Aluno_Id),
    INDEX idx_disciplina (Disciplina_IdDisciplina),
    INDEX idx_status (Status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- =====================================================
-- 3. ADICIONAR FOREIGN KEYS COM CASCADE DELETE
-- =====================================================

-- ✅ Cursos -> Departamentos (DELETE CASCADE)
ALTER TABLE Cursos
ADD CONSTRAINT fk_curso_departamento 
    FOREIGN KEY (Departamentos_idDepartamentos) 
    REFERENCES Departamentos(idDepartamentos)
    ON DELETE CASCADE
    ON UPDATE CASCADE;

-- ✅ Disciplinas -> Cursos (DELETE CASCADE)
ALTER TABLE Disciplinas
ADD CONSTRAINT fk_disciplina_curso 
    FOREIGN KEY (Curso_IdCursos) 
    REFERENCES Cursos(IdCursos)
    ON DELETE CASCADE
    ON UPDATE CASCADE;

-- ✅ Disciplinas -> Professores (DELETE SET NULL - disciplina fica sem professor)
ALTER TABLE Disciplinas
ADD CONSTRAINT fk_disciplina_professor 
    FOREIGN KEY (Professor_IdProfessores) 
    REFERENCES Professores(IdProfessores)
    ON DELETE SET NULL
    ON UPDATE CASCADE;

-- ✅ Matricula -> Aluno (DELETE CASCADE)
ALTER TABLE Matricula
ADD CONSTRAINT fk_matricula_aluno 
    FOREIGN KEY (Aluno_Id) 
    REFERENCES Aluno(Id)
    ON DELETE CASCADE
    ON UPDATE CASCADE;

-- ✅ Matricula -> Curso (DELETE CASCADE)
ALTER TABLE Matricula
ADD CONSTRAINT fk_matricula_curso 
    FOREIGN KEY (Curso_IdCursos) 
    REFERENCES Cursos(IdCursos)
    ON DELETE CASCADE
    ON UPDATE CASCADE;

-- ✅ Notas -> Aluno (DELETE CASCADE)
ALTER TABLE Notas
ADD CONSTRAINT fk_nota_aluno 
    FOREIGN KEY (Aluno_Id) 
    REFERENCES Aluno(Id)
    ON DELETE CASCADE
    ON UPDATE CASCADE;

-- ✅ Notas -> Disciplina (DELETE CASCADE)
ALTER TABLE Notas
ADD CONSTRAINT fk_nota_disciplina 
    FOREIGN KEY (Disciplina_IdDisciplina) 
    REFERENCES Disciplinas(IdDisciplina)
    ON DELETE CASCADE
    ON UPDATE CASCADE;

-- =====================================================
-- 4. INSERIR DADOS DE EXEMPLO
-- =====================================================

-- Inserir Departamentos
INSERT INTO Departamentos (Nome, Codigo, Descricao) VALUES
('Ciências Exatas', 'CEX', 'Departamento de Matemática, Física e Química'),
('Computação', 'DCC', 'Departamento de Ciência da Computação'),
('Engenharias', 'ENG', 'Departamento de Engenharias'),
('Humanas', 'HUM', 'Departamento de Ciências Humanas'),
('Saúde', 'SAU', 'Departamento de Ciências da Saúde');

-- Inserir Usuários (senha: admin123)
INSERT INTO Usuario (Username, PasswordHash, Email, DataCriacao) VALUES
('admin', 'jGl25bVBBBW96Qi9Te4V37Fnqchz/Eu4qB9vKrRIqRg=', 'admin@universidade.com', NOW()),
('professor1', 'jGl25bVBBBW96Qi9Te4V37Fnqchz/Eu4qB9vKrRIqRg=', 'professor@universidade.com', NOW()),
('aluno1', 'jGl25bVBBBW96Qi9Te4V37Fnqchz/Eu4qB9vKrRIqRg=', 'aluno@universidade.com', NOW());

-- Inserir Professores
INSERT INTO Professores (Nome, Cpf, Email, Telefone, Especializacao, DataContratacao, Salario) VALUES
('Dr. João Silva', '12345678901', 'joao.silva@universidade.com', '11987654321', 'Algoritmos e Estruturas de Dados', '2020-01-15', 8500.00),
('Dra. Maria Santos', '23456789012', 'maria.santos@universidade.com', '11987654322', 'Banco de Dados', '2019-03-20', 9000.00),
('Prof. Carlos Oliveira', '34567890123', 'carlos.oliveira@universidade.com', '11987654323', 'Engenharia de Software', '2021-06-10', 7800.00),
('Dra. Ana Costa', '45678901234', 'ana.costa@universidade.com', '11987654324', 'Inteligência Artificial', '2018-08-25', 9500.00),
('Prof. Pedro Almeida', '56789012345', 'pedro.almeida@universidade.com', '11987654325', 'Redes de Computadores', '2022-02-01', 8000.00);

-- Inserir Cursos
INSERT INTO Cursos (Nome, CargaHoraria, Descricao, Nivel, Departamentos_idDepartamentos) VALUES
('Ciência da Computação', '3200h', 'Bacharelado em Ciência da Computação', 'Graduação', 2),
('Engenharia de Software', '3600h', 'Bacharelado em Engenharia de Software', 'Graduação', 2),
('Sistemas de Informação', '3000h', 'Bacharelado em Sistemas de Informação', 'Graduação', 2),
('Análise e Desenvolvimento de Sistemas', '2400h', 'Curso Tecnólogo em ADS', 'Técnico', 2),
('Mestrado em Computação', '1800h', 'Mestrado em Ciência da Computação', 'Mestrado', 2);

-- Inserir Alunos
INSERT INTO Aluno (NomeCompleto, DataNascimento, Cpf, Endereco, Telefone, Email, DataMatricula, Status) VALUES
('Gabriel Passarin Vicente', '2000-05-15', '11122233344', 'Rua das Flores, 123', '11999887766', 'gabriel@email.com', NOW(), 'Ativo'),
('Juliana Mendes Silva', '1999-08-20', '22233344455', 'Av. Paulista, 456', '11999887767', 'juliana@email.com', NOW(), 'Ativo'),
('Roberto Carlos Souza', '2001-03-10', '33344455566', 'Rua dos Pinheiros, 789', '11999887768', 'roberto@email.com', NOW(), 'Ativo'),
('Fernanda Lima Costa', '2000-11-25', '44455566677', 'Rua Augusta, 321', '11999887769', 'fernanda@email.com', NOW(), 'Ativo'),
('Lucas Rodrigues Alves', '1998-07-30', '55566677788', 'Av. Ipiranga, 654', '11999887770', 'lucas@email.com', NOW(), 'Ativo');

-- Inserir Disciplinas
INSERT INTO Disciplinas (Nome, Codigo, CargaHoraria, Creditos, Ementa, Curso_IdCursos, Professor_IdProfessores) VALUES
('Algoritmos e Programação I', 'CC101', 80, 4, 'Introdução à lógica de programação e algoritmos', 1, 1),
('Estrutura de Dados', 'CC102', 80, 4, 'Listas, pilhas, filas, árvores e grafos', 1, 1),
('Banco de Dados I', 'CC201', 80, 4, 'Modelagem e implementação de bancos de dados', 1, 2),
('Engenharia de Software', 'CC301', 80, 4, 'Processos, metodologias e ferramentas', 1, 3),
('Inteligência Artificial', 'CC401', 80, 4, 'Algoritmos de IA e Machine Learning', 1, 4),
('Redes de Computadores', 'CC501', 80, 4, 'Protocolos e arquitetura de redes', 1, 5);

-- Inserir Matrículas
INSERT INTO Matricula (Aluno_Id, Curso_IdCursos, Semestre, Ano, Status) VALUES
(1, 1, '2025/1', 2025, 'Cursando'),
(2, 1, '2025/1', 2025, 'Cursando'),
(3, 2, '2025/1', 2025, 'Cursando'),
(4, 3, '2025/1', 2025, 'Cursando'),
(5, 4, '2025/1', 2025, 'Cursando');

-- Inserir Notas
INSERT INTO Notas (Aluno_Id, Disciplina_IdDisciplina, Nota1, Nota2, NotaFinal, Frequencia, Status, Semestre, Ano) VALUES
(1, 1, 8.5, 9.0, 8.75, 95.0, 'Cursando', '2025/1', 2025),
(1, 2, 7.0, 8.5, 7.75, 90.0, 'Cursando', '2025/1', 2025),
(2, 1, 9.0, 9.5, 9.25, 100.0, 'Cursando', '2025/1', 2025),
(2, 3, 8.0, 8.5, 8.25, 92.0, 'Cursando', '2025/1', 2025),
(3, 4, 7.5, 8.0, 7.75, 88.0, 'Cursando', '2025/1', 2025);

-- =====================================================
-- 5. CRIAR VIEWS ÚTEIS
-- =====================================================

-- View: Alunos com seus cursos
CREATE OR REPLACE VIEW vw_alunos_cursos AS
SELECT 
    a.Id AS AlunoId,
    a.NomeCompleto,
    a.Email,
    a.Cpf,
    c.IdCursos AS CursoId,
    c.Nome AS NomeCurso,
    m.Semestre,
    m.Ano,
    m.Status AS StatusMatricula
FROM Aluno a
INNER JOIN Matricula m ON a.Id = m.Aluno_Id
INNER JOIN Cursos c ON m.Curso_IdCursos = c.IdCursos;

-- View: Cursos com departamentos
CREATE OR REPLACE VIEW vw_cursos_departamentos AS
SELECT 
    c.IdCursos,
    c.Nome AS NomeCurso,
    c.CargaHoraria,
    c.Nivel,
    d.idDepartamentos,
    d.Nome AS NomeDepartamento,
    d.Codigo AS CodigoDepartamento
FROM Cursos c
INNER JOIN Departamentos d ON c.Departamentos_idDepartamentos = d.idDepartamentos;

-- View: Boletim dos alunos
CREATE OR REPLACE VIEW vw_boletim_alunos AS
SELECT 
    a.Id AS AlunoId,
    a.NomeCompleto,
    d.Nome AS Disciplina,
    d.Codigo AS CodigoDisciplina,
    p.Nome AS Professor,
    n.Nota1,
    n.Nota2,
    n.NotaFinal,
    n.Frequencia,
    n.Status,
    n.Semestre,
    n.Ano
FROM Aluno a
INNER JOIN Notas n ON a.Id = n.Aluno_Id
INNER JOIN Disciplinas d ON n.Disciplina_IdDisciplina = d.IdDisciplina
LEFT JOIN Professores p ON d.Professor_IdProfessores = p.IdProfessores;

-- View: Disciplinas por curso
CREATE OR REPLACE VIEW vw_disciplinas_curso AS
SELECT 
    c.IdCursos,
    c.Nome AS NomeCurso,
    d.IdDisciplina,
    d.Nome AS NomeDisciplina,
    d.Codigo,
    d.CargaHoraria,
    d.Creditos,
    p.Nome AS Professor
FROM Cursos c
INNER JOIN Disciplinas d ON c.IdCursos = d.Curso_IdCursos
LEFT JOIN Professores p ON d.Professor_IdProfessores = p.IdProfessores;

-- =====================================================
-- 6. VERIFICAR CONSTRAINTS CRIADAS
-- =====================================================

SELECT 
    '✅ VERIFICAÇÃO DE FOREIGN KEYS COM CASCADE' AS Titulo;

SELECT 
    TABLE_NAME AS Tabela,
    CONSTRAINT_NAME AS Constraint,
    REFERENCED_TABLE_NAME AS TabelaReferenciada,
    DELETE_RULE AS RegraDelete,
    UPDATE_RULE AS RegraUpdate
FROM 
    INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS
WHERE 
    CONSTRAINT_SCHEMA = 'mydb'
ORDER BY 
    TABLE_NAME;

-- =====================================================
-- 7. RESUMO E ESTATÍSTICAS
-- =====================================================

SELECT '✅ BANCO DE DADOS CRIADO COM SUCESSO!' AS Status;
SELECT 'Todas as exclusões estão configuradas em CASCADE' AS Configuracao;

SELECT 'ESTATÍSTICAS DO BANCO' AS Titulo;
SELECT COUNT(*) AS TotalDepartamentos FROM Departamentos;
SELECT COUNT(*) AS TotalUsuarios FROM Usuario;
SELECT COUNT(*) AS TotalProfessores FROM Professores;
SELECT COUNT(*) AS TotalCursos FROM Cursos;
SELECT COUNT(*) AS TotalAlunos FROM Aluno;
SELECT COUNT(*) AS TotalDisciplinas FROM Disciplinas;
SELECT COUNT(*) AS TotalMatriculas FROM Matricula;
SELECT COUNT(*) AS TotalNotas FROM Notas;

-- =====================================================
-- COMPORTAMENTO DA EXCLUSÃO EM CASCATA:
-- =====================================================

/*
🗑️ DELETAR DEPARTAMENTO (ID=1):
   ├─ Deleta todos os CURSOS do departamento
   │  ├─ Deleta todas as DISCIPLINAS dos cursos
   │  │  └─ Deleta todas as NOTAS das disciplinas
   │  └─ Deleta todas as MATRÍCULAS dos cursos
   
🗑️ DELETAR CURSO (ID=1):
   ├─ Deleta todas as DISCIPLINAS do curso
   │  └─ Deleta todas as NOTAS das disciplinas
   └─ Deleta todas as MATRÍCULAS do curso

🗑️ DELETAR PROFESSOR (ID=1):
   └─ Define Professor_IdProfessores = NULL nas disciplinas
      (Disciplinas continuam existindo, mas SEM professor)

🗑️ DELETAR ALUNO (ID=1):
   ├─ Deleta todas as MATRÍCULAS do aluno
   └─ Deleta todas as NOTAS do aluno

🗑️ DELETAR DISCIPLINA (ID=1):
   └─ Deleta todas as NOTAS da disciplina

✅ TODOS OS DELETES ESTÃO CONFIGURADOS COM CASCADE!
✅ Você pode deletar qualquer registro sem erro de constraint!
*/
